import{a0 as T,e as w,y as l,a1 as f,a2 as u,A as d}from"./chunk-pg-brands.8ca8676c.js";const b=T(async(h,_)=>{let t,n;const s=w(),o=l("token_access"),c=l("token_refresh");function i(e){const a=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),g=decodeURIComponent(atob(a).split("").map(function(m){return"%"+("00"+m.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(g)}o.value;function p(e){if(!e)return!0;const r=i(e),a=Date.now().valueOf()/1e3;return r.exp<=a}function v(e){if(!e)return!1;const r=i(e),a=Date.now().valueOf()/1e3;return r.exp>a}async function y(){if(p(c.value))return!1;try{const e=await d("/token/refresh/",{method:"POST",body:{refresh:c.value}});return e.data&&e.data.value&&e.data.value.access?(o.value=e.data.value.access,!0):!1}catch(e){return console.log(e),!1}}async function k(e){try{return(await d("/token/verify/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})})).data.value!==null}catch(r){return console.log("Error verifying token:",r),!1}}if(h.path==="/user/login")return s.isAuthenticated||o.value&&v(o.value)?f("/user"):void 0;if(!s.isAuthenticated&&!([t,n]=u(()=>k(o.value)),t=await t,n(),t)&&!([t,n]=u(()=>y()),t=await t,n(),t)){try{[t,n]=u(()=>$fetch("/api/logout")),await t,n()}catch(a){console.error("Ошибка при выходе из системы",a)}return s.logout(),f("/user/login")}});export{b as default};
